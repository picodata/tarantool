variables:
    # set larger git depth, so git describe works properly
    GIT_DEPTH: 0
    USER: 'tarantool'

stages:
  - test
  - build
  - pack
  - sign
  - deploy
  - check-deployment
  - docker

luacheck:
    stage: test
    tags: [docker]
    image: docker-public.binary.picodata.io/tarantool-testing:latest
    before_script:
      - git submodule update --init --recursive
      - git submodule foreach --recursive 'git clean -xffd'
      - git clean -xffd
    script:
      - make -f .test.mk luacheck

test:
    stage: test
    retry: 2
    tags: [docker]
    image: docker-public.binary.picodata.io/tarantool-testing:latest
    before_script:
      - git submodule update --init --recursive
      - git submodule foreach --recursive 'git clean -xffd'
      - git clean -xffd
    script:
      - make -f .test.mk test-release

checkpatch:
    stage: test
    tags: [shell_p_t]
    before_script:
      - git submodule update --init --recursive
      - git submodule foreach --recursive 'git clean -xffd'
      - git clean -xffd
      - git clone git@github.com:tarantool/checkpatch.git
    script:
      - checkpatch/checkpatch.pl --color=always --git HEAD~1..HEAD

# run long tests and coverage on release build
coverage:
    stage: build
    only:
      - web
      - tags
    retry: 2
    tags: [docker]
    image: docker-public.binary.picodata.io/tarantool-testing:latest
    variables:
      TEST_RUN_RETRIES: 3
      SERVER_START_TIMEOUT: 400
      REPLICATION_SYNC_TIMEOUT: 400
      TEST_TIMEOUT: 400
      NO_OUTPUT_TIMEOUT: 400
    before_script:
      - git submodule update --init --recursive
      - git submodule foreach --recursive 'git clean -xffd'
      - git clean -xffd
    script:
      - make -f .test.mk test-coverage

.pack:
  tags:
    - shell_p_t
  only:
    - web
    - tags
  variables:
    MAKE_CHECK: 'false'
    PRESERVE_ENVVARS: MAKE_CHECK
  before_script:
    - git describe --long
    - git submodule update --init --recursive
    - git submodule foreach --recursive 'git clean -xffd'
    - git clean -xffd
    - rm rpm/tarantool.spec
    - rm -rf debian
    - cp -r debian-picodata debian
  timeout: 2h
  dependencies: []

build-package-centos:
  stage: pack
  extends: .pack
  script:
    - OS=centos DIST=7 BUILDDIR=$PWD/build_rpm/ make -f .pack.mk package
    - OS=centos DIST=8 BUILDDIR=$PWD/build_rpm/ make -f .pack.mk package
  artifacts:
    paths:
      - build_rpm/tarantool*.rpm

build-package-altlinux:
  stage: pack
  extends: .pack
  script:
    - git clone https://github.com/packpack/packpack.git packpack
    - DOCKER_REPO=docker-picodata.binary.picodata.io/packpack/alt DOCKER_IMAGE=p9 BUILDDIR=$PWD/build_rpm/ packpack/packpack
    - DOCKER_REPO=docker-picodata.binary.picodata.io/packpack/alt DOCKER_IMAGE=p10 BUILDDIR=$PWD/build_rpm/ packpack/packpack
  artifacts:
    paths:
      - build_rpm/tarantool*.rpm

build-package-ubuntu:
  stage: pack
  extends: .pack
  script:
    - OS=ubuntu DIST=focal BUILDDIR=$PWD/build_${DIST}/ RELEASE=${DIST} make -f .pack.mk package
    - OS=ubuntu DIST=jammy BUILDDIR=$PWD/build_${DIST}/ RELEASE=${DIST} make -f .pack.mk package
  artifacts:
    paths:
      - build_focal/*.deb
      - build_jammy/*.deb

build-package-debian:
  stage: pack
  extends: .pack
  script:
    - OS=debian DIST=bullseye BUILDDIR=$PWD/build_${DIST}/ RELEASE=${DIST} make -f .pack.mk package
  artifacts:
    paths:
      - build_bullseye/*.deb

build-package-redos:
  stage: pack
  extends: .pack
  script:
    - OS=redos DIST=7.3 BUILDDIR=$PWD/build_redos/ make -f .pack.mk package
  artifacts:
    paths:
      - build_redos/tarantool*.rpm

build-package-astralinux:
  stage: pack
  extends: .pack
  script:
    - git clone https://github.com/packpack/packpack.git packpack
    - DOCKER_REPO=docker-picodata.binary.picodata.io/packpack/astra DOCKER_IMAGE=orel-2.12 BUILDDIR=$PWD/build_astra packpack/packpack
  artifacts:
    paths:
      - build_astra/*.deb

sign-rpm-packages:
  variables:
    DOCKER_AUTH_CONFIG: $DOCKER_AUTH_RO
  stage: sign
  tags:
    - shell_p_t
  only:
    - web
    - tags
  before_script:
    - mkdir -p $CI_PROJECT_DIR/.docker
    - echo $DOCKER_AUTH_RW > $CI_PROJECT_DIR/.docker/config.json
    - echo "$GPG_KEY_KDY" | base64 -d > build_rpm/kdy.asc
    - echo "$GPG_KEY_KDY" | base64 -d > build_redos/kdy.asc
  script:
    - docker run --rm -e KEY_FILE=kdy.asc -v $PWD/build_rpm:/build docker-picodata.binary.picodata.io/rpmsign:centos7
    - docker run --rm -e KEY_FILE=kdy.asc -v $PWD/build_redos:/build docker-picodata.binary.picodata.io/rpmsign:centos7
  artifacts:
    paths:
      - build_rpm/tarantool*.rpm
      - build_redos/tarantool*.rpm
  dependencies:
    - build-package-centos
    - build-package-altlinux
    - build-package-redos

sign-astralinux-packages:
  variables:
    DOCKER_AUTH_CONFIG: $DOCKER_AUTH_RO
  stage: sign
  tags:
    - shell_p_t
  only:
    - web
    - tags
  before_script:
    - mkdir -p $CI_PROJECT_DIR/.docker
    - echo $DOCKER_AUTH_RW > $CI_PROJECT_DIR/.docker/config.json
    - echo "$GPG_KEY_ASTRA" | base64 -d > build_astra/pico.asc
    - echo "$GPG_PASS_ASTRA" | base64 -d > build_astra/pico.pass
  script:
    - docker run --rm -e KEY_FILE=pico.asc -e PASS_FILE=pico.pass -e SIGNER="5A7D5C9D749260B6CCD24D72A45397D5554CBECD" -v $PWD/build_astra:/build docker-picodata.binary.picodata.io/astrasign:orel-2.12
  artifacts:
    paths:
      - build_astra/tarantool*_signed.deb
  dependencies:
    - build-package-astralinux

deploy-job:
  stage: deploy
  tags:
    - shell_p_t
  only:
#    - web
    - tags
  before_script:
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_PROD_SSH_KEY" | base64 -d | ssh-add -
    - echo "$GPG_KEY_KDY" | base64 -d > /tmp/key.asc
  script:
    - echo "Deploying application..."
    - echo
    - echo "Deploying rpm-packets..."
    # CentOS7
    - scp -o stricthostkeychecking=no build_rpm/tarantool*.el7.*rpm ansible@94.26.239.246:/data/nginx/www/packrepo/tarantool-picodata/el/7/x86_64/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "cd /data/nginx/www/packrepo/tarantool-picodata/el/7/ && createrepo --update x86_64 && gpg --no-tty --yes -u kdy@picodata.io --detach-sign --armor x86_64/repodata/repomd.xml"
    # CentOS8
    - scp -o stricthostkeychecking=no build_rpm/tarantool*.el8.*rpm ansible@94.26.239.246:/data/nginx/www/packrepo/tarantool-picodata/el/8/x86_64/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "cd /data/nginx/www/packrepo/tarantool-picodata/el/8/ && createrepo --update x86_64 && gpg --no-tty --yes -u kdy@picodata.io --detach-sign --armor x86_64/repodata/repomd.xml"
    - echo "rpm-packets successfully deployed."
    - echo
    # Ubuntu focal
    - echo "Deploying deb-packets..."
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "mkdir -p ~/.deb/tnt-focal"
    - scp -o stricthostkeychecking=no build_focal/tarantool*deb ansible@94.26.239.246:.deb/tnt-focal/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "reprepro -b /data/nginx/www/packrepo/tarantool-picodata/ubuntu/ -C main includedeb focal ~/.deb/tnt-focal/tarantool*deb; rm -rf ~/.deb/tnt-focal"
    # Ubuntu jammy
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "mkdir -p ~/.deb/tnt-jammy"
    - scp -o stricthostkeychecking=no build_jammy/tarantool*deb ansible@94.26.239.246:.deb/tnt-jammy/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "reprepro -b /data/nginx/www/packrepo/tarantool-picodata/ubuntu/ -C main includedeb jammy ~/.deb/tnt-jammy/tarantool*deb; rm -rf ~/.deb/tnt-jammy"
    # Debian bullseye
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "mkdir -p ~/.deb/tnt-bullseye"
    - scp -o stricthostkeychecking=no build_bullseye/tarantool*deb ansible@94.26.239.246:.deb/tnt-bullseye/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "reprepro -b /data/nginx/www/packrepo/tarantool-picodata/debian/ -C main includedeb bullseye ~/.deb/tnt-bullseye/tarantool*deb; rm -rf ~/.deb/tnt-bullseye"
    - echo "deb-packets successfully deployed."
    - echo
    # Altlinux p9
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "mkdir -p /tmp/altlinux/"
    - echo "Deploying altlinux-p9 packet..."
    - scp -o stricthostkeychecking=no build_rpm/tarantool*.p9.*rpm ansible@94.26.239.246:/tmp/altlinux/
    - echo "altlinux-p9 packet successfully deployed."
    - echo
    # Altlinux p10
    - echo "Deploying altlinux-p10 packet..."
    - scp -o stricthostkeychecking=no build_rpm/tarantool*.p10.*rpm ansible@94.26.239.246:/tmp/altlinux/
    - echo "altlinux-p10 packet successfully deployed."
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "/usr/local/bin/repogen.sh"
    - echo "Altlinux packets successfully deployed."
    - echo
    # RedOS
    - echo "Deploying RedOS 7 packet..."
    - scp -o stricthostkeychecking=no build_redos/tarantool*.el7.*rpm ansible@94.26.239.246:/data/nginx/www/packrepo/tarantool-picodata/redos/7/x86_64/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "cd /data/nginx/www/packrepo/tarantool-picodata/redos/7/ && createrepo --update x86_64 && gpg --no-tty --yes -u kdy@picodata.io --detach-sign --armor x86_64/repodata/repomd.xml"
    - echo "RedOS 7 packet successfully deployed."
    - echo
    # Astralinux
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "mkdir -p ~/.deb/tnt-astra"
    - scp -o stricthostkeychecking=no build_astra/tarantool*_signed.deb ansible@94.26.239.246:.deb/tnt-astra/
    - ssh -o stricthostkeychecking=no ansible@94.26.239.246 "reprepro -b /data/nginx/www/packrepo/tarantool-picodata/astra -C main includedeb orel ~/.deb/tnt-astra/tarantool*_signed.deb; rm -rf ~/.deb/tnt-astra"
    - echo "Astralinux-packets successfully deployed."
    - echo
    - echo "Application successfully deployed."
  dependencies:
    - build-package-debian
    - build-package-ubuntu
    - sign-rpm-packages
    - sign-astralinux-packages

.check-deployment:
  stage: check-deployment
  tags:
    - docker
  only:
#    - web
    - tags
  image: ${BASE_IMAGE}
  needs:
    - deploy-job

check_deployment_rpm:
  extends: .check-deployment
  parallel:
    matrix:
      - BASE_IMAGE: centos:7
        PACKAGE: el/7/x86_64/picodata-release-1.1.1.0-1.el7.x86_64.rpm
      - BASE_IMAGE: rockylinux:8
        PACKAGE: el/8/x86_64/picodata-release-1.1.1.0-1.el8.x86_64.rpm
      - BASE_IMAGE: packpack/packpack:redos-7.3
        PACKAGE: redos/7/x86_64/picodata-release-1.1.1.0-1.el7.x86_64.rpm
  before_script:
    - yum install -y git
    - until git describe; do git fetch --deepen 100; done
    - export VER=$(git describe --long | sed -n 's/^\([0-9\.]*\)-\([0-9]*\)-\([a-z0-9]*\)/\1.\2/p')
  script:
    - rpm --import https://download.picodata.io/tarantool-picodata/el/RPM-GPG-KEY-kdy
    - yum install -y https://download.picodata.io/tarantool-picodata/${PACKAGE}
    - yum install -y tarantool-picodata-$VER tarantool-picodata-devel-$VER

check-deployment-deb:
  extends: .check-deployment
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Moscow
  parallel:
    matrix:
      - BASE_IMAGE: debian:bullseye
      - BASE_IMAGE: ubuntu:focal
      - BASE_IMAGE: ubuntu:jammy
  before_script:
    - apt update
    - apt install -y curl gpg software-properties-common git
    - export DIST=$(lsb_release -si | tr [:upper:] [:lower:])
    - export CODENAME=$(lsb_release -sc)
    - until git describe; do git fetch --deepen 100; done
    - export VER=$(git describe --long | sed -n 's/^\([0-9\.]*\)-\([0-9]*\)-\([a-z0-9]*\)/\1.\2/p')
  script:
    - curl -s https://download.picodata.io/tarantool-picodata/ubuntu/picodata.gpg.key | gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/picodata.gpg --import
    - chmod 644 /etc/apt/trusted.gpg.d/picodata.gpg
    - add-apt-repository -y "deb [arch=amd64] https://download.picodata.io/tarantool-picodata/${DIST}/ ${CODENAME} main"
    - apt update
    - apt install -y tarantool-picodata=$VER tarantool-picodata-devel=$VER

check-deployment-alt:
  extends: .check-deployment
  parallel:
    matrix:
      - DIST: p10
      - DIST: p9
  image: docker.binary.picodata.io/altlinux/base:${DIST}
  before_script:
    - apt-get update
    - apt-get install -y curl git apt-https
    - until git describe; do git fetch --deepen 100; done
    - export VER=$(git describe --long | sed -n 's/^\([0-9\.]*\)-\([0-9]*\)-\([a-z0-9]*\)/\1.\2/p')
  script:
    - apt-get install -y https://download.picodata.io/tarantool-picodata/altlinux/${DIST}/picodata-release-1.0.2.7-1.${DIST}.x86_64.rpm
    - apt-get update
    - apt-get install -y tarantool-picodata=$VER tarantool-picodata-devel=$VER

check-deployment-astra:
  extends: .check-deployment
  image: docker-picodata.binary.picodata.io/astra/orel:2.12
  before_script:
    - apt-get update
    - apt-get install -y curl git apt-transport-https
    - until git describe; do git fetch --deepen 100; done
    - export VER=$(git describe --long | sed -n 's/^\([0-9\.]*\)-\([0-9]*\)-\([a-z0-9]*\)/\1.\2/p')
  script:
    - curl -s https://download.picodata.io/tarantool-picodata/ubuntu/picodata.gpg.key | gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/picodata.gpg --import
    - chmod 644 /etc/apt/trusted.gpg.d/picodata.gpg
    - echo "deb [arch=amd64] https://download.picodata.io/tarantool-picodata/astra/ orel main" > /etc/apt/sources.list.d/picodata.list
    - apt-get update
    - apt-get install -y tarantool-picodata=$VER tarantool-picodata-devel=$VER

docker:
  stage: docker
  only:
#    - web
    - tags
  variables:
    DOCKER_REGISTRY_PUB: docker-public.binary.picodata.io
    DOCKER_AUTH_CONFIG: $DOCKER_AUTH_RW
  tags:
    - shell_p_t
  before_script:
    - mkdir -p $CI_PROJECT_DIR/.docker
    - echo $DOCKER_AUTH_RW > $CI_PROJECT_DIR/.docker/config.json
    - TAG=$(git describe | awk -F- '{print $1}')
    - echo $TAG
  script:
    - docker build docker/ -t $DOCKER_REGISTRY_PUB/tarantool:$TAG
    - docker --config $CI_PROJECT_DIR/.docker/ push $DOCKER_REGISTRY_PUB/tarantool:$TAG
  dependencies: []